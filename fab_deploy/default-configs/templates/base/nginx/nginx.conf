{% block globals %}
worker_processes {{ worker_processes }};
{% if worker_rlimit %}
worker_rlimit_nofile {{ worker_rlimit }};
{% endif %}

events {
    worker_connections  {{ worker_connections }};
}
{% endblock %}



http {

    {% block http %}
    # Basic Settings
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout {{ keepalive_timeout }};
    types_hash_max_size {{ hash_max_size }};

    {% if client_max_body_size %}
        client_max_body_size {{ client_max_body_size }}
    {% endif %}

    include {{ mime_types_file }};
    default_type application/octet-stream;
    {% endblock %}

    {% block logs %}
    # Logging Settings
    access_log {{ nginx_access_log_file }};
    error_log {{ nginx_error_log_file }};
    {% endblock %}

    {% block gzip %}
    # Gzip Settings
    gzip on;
    gzip_min_length 1100;
    gzip_types
        text/plain
        text/xml
        text/css
        text/javascript
        application/javascript
        application/json
        application/x-javascript;
    gzip_proxied expired no-cache no-store private auth;
    gzip_vary on;
    gzip_disable "msie6";
    {% endblock %}

    {% block allowed_ips %}
    {% if lbs %}
        ## Start Allowed IPs ##
        {% for lb in lbs %}
        set_real_ip_from  {{ lb }};
        {% endfor %}
        real_ip_header    X-Cluster-Client-Ip;
        ## End Allowed IPs ##
    {% endif %}
    {% endblock %}

    {% block caches %}
    {% if do_cache %}
        proxy_cache_path /var/www/cache levels=1:2 keys_zone=app-cache:128m inactive=10m;
        proxy_temp_path /var/www/cache-tmp;
    {% endif %}
    {% endblock %}

    {% block upstreams %}
        #Add application servers
        {% for upstream_address in upstream_addresses %}
        upstream app_servers {
           server   {{ upstream_address }} max_fails={{ upstream_max_fails }}  fail_timeout={{ upstream_timeout }};
        }
        {% endfor %}
    {% endblock %}

    {% block servers %}
    server {
        {% block listen %}
        listen 80;
        {% endblock %}


        {% block error_pages %}
        error_page   502 503 504  /static/50x.html;
        error_page   403  /static/maintenance.html;
        {% endblock %}

        {% block static_location %}
        location /static/ {
            alias {{ static_location }};
            add_header Access-Control-Allow-Origin *;
            expires {{ static_expiry }};
        }
        {% endblock %}

        {% block uploads_location %}
            location /uploads/ {
                alias {{ uploads_location }};
                expires {{ uploads_expiry }};
            }
        {% endblock %}

        {% block local_files %}
            location /favicon.ico {
                alias {{ static_location }}/local/crossdomain.xml;
                expires {{ static_expiry }};
            }

            location /crossdomain.xml {
                alias {{ static_location }}/local/crossdomain.xml;
                expires {{ static_expiry }};
            }

            location /robots.txt {
                alias {{ static_location }}/local/robots.txt;
                expires {{ static_expiry }};
            }
        {% endblock %}

        {% block upstream_location %}
            location / {
                allow all;
                proxy_pass http://app_servers;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Cluster-Client-Ip $remote_addr;

                {% if do_cache %}
                proxy_cache app-cache;
                proxy_cache_key $scheme$request_uri;
                proxy_cache_valid  200 302 301 2m;
                proxy_cache_use_stale updating timeout http_503;
                {% endif %}

                {% if auth_file %}
                auth_basic "Restricted";
                auth_basic_user_file {{ auth_file }};
                {% endif %}
            }
        {% endblock %}
    }
    {% endblock %}
}
